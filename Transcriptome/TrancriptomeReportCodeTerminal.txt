# Create a new environment for transcriptomics
mamba create -n transcriptomics

# activate that environment
mamba activate transcriptomics

# install the necessary packages
conda install -c bioconda hisat2
conda install -c bioconda samtools
conda install -c bioconda stringtie
conda install -c bioconda gffcompare

# Navigate into folder 
cd /Users/allywatkins/Downloads/BioinformaticsExternalHardrive/Transcriptome 

# What is this code doing? This code is unzipping my reference genome files 
gunzip fastq/*.gz

# Prepare the genome file
hisat2-build /Users/allywatkins/Downloads/BioinformaticsExternalHardrive/Transcriptome/paeruginosa.fna paeru

# Align reads to genome and assemble the transcripts #you will need to do these commands for every pair of reads (there are 4 in the tutorial). As an example, this is the command I ran for the plank01 sample

hisat2 -q -x paeru -1 fastq/plank01_F.fastq -2 fastq/plank01_R.fastq -S plank01.sam
hisat2 -q -x paeru -1 fastq/plank02_F.fastq -2 fastq/plank02_R.fastq -S plank02.sam
hisat2 -q -x paeru -1 fastq/biofilm01_F.fastq -2 fastq/biofilm01_R.fastq -S biofilm01.sam
hisat2 -q -x paeru -1 fastq/biofilm02_F.fastq -2 fastq/biofilm02_R.fastq -S biofilm02.sam

# Convert the .sam file to a .bam file.

samtools view -bS plank01.sam > plank01.bam
samtools view -bS plank02.sam > plank02.bam
samtools view -bS biofilm01.sam > biofilm01.bam
samtools view -bS biofilm02.sam > biofilm02.bam

# Convert the .bam to a sorted .bam. This compresses the file and sorts the variants for easier discovery. 

samtools sort plank01.bam -o plank01.sorted.bam
samtools sort plank02.bam -o plank02.sorted.bam
samtools sort biofilm01.bam -o bioiflm01.sorted.bam
samtools sort biofilm02.bam -o biofilm02.sorted.bam

# Reconstruct transcripts for each sample.

stringtie plank01.sorted.bam -G paeruginosa.gff -o stringtie/plank01.transcripts.gtf
stringtie plank02.sorted.bam -G paeruginosa.gff -o stringtie/plank02.transcripts.gtf
stringtie bioiflm01.sorted.bam -G paeruginosa.gff -o stringtie/bioiflm01.transcripts.gtf
stringtie biofilm02.sorted.bam -G paeruginosa.gff -o stringtie/biofilm02.transcripts.gtf

# Create a file with the names of the files.

echo stringtie/plank01.transcripts.gtf > assemblies.txt

echo stringtie/plank02.transcripts.gtf >> assemblies.txt

echo stringtie/bioiflm01.transcripts.gtf >> assemblies.txt

echo stringtie/bioifilm02.transcripts.gtf >> assemblies.txt

# Verify that assemblies.txt contains all file names

# Merge the transcripts
stringtie --merge -G paeruginosa.gff -o stringtie_merged.gtf assemblies.txt

# Count the number of lines in the merged file # there are 5737 lines
cat stringtie_merged.gtf | grep -v "^#" | awk '$3=="transcript" {print}' | wc -l

# Compare assembled transcripts to known transcripts # 5678 reference transcripts loaded # 5737 query transferals loaded 
gffcompare -r paeruginosa.gff -G -o merged stringtie_merged.gtf

# View success of comparison # 5737 out of 5737 consensus transcripts written in merged.annotated.gtf (0 discarded as redundant)
  cat merged.stats

# Estimate abundance and create Ballgown folder (for use in visualization)
stringtie -e -B -p 8 -G stringtie_merged.gtf -o ballgown/plank01/plank01.gtf plank01.sorted.bam
stringtie -e -B -p 8 -G stringtie_merged.gtf -o ballgown/plank02/plank02.gtf plank02.sorted.bam
stringtie -e -B -p 8 -G stringtie_merged.gtf -o ballgown/biofilm01/biofilm01.gtf biofilm01.sorted.bam
stringtie -e -B -p 8 -G stringtie_merged.gtf -o ballgown/biofilm02/biofilm02.gtf biofilm02.sorted.bam




